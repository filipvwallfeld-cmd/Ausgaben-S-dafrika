<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Kapstadt" />
  <title>Kapstadt Tracker</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Lato:wght@300;400&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: linear-gradient(160deg, #1a0a00 0%, #3d1a05 40%, #1a0f2e 100%); min-height: 100vh; }
    .card { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,160,60,0.2); border-radius: 16px; padding: 22px; backdrop-filter: blur(10px); }
    .field-label { font-size: 11px; color: rgba(245,230,208,0.5); display: block; margin-bottom: 6px; font-family: 'Lato', sans-serif; letter-spacing: 1px; text-transform: uppercase; }
    input, select { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,160,60,0.35); border-radius: 10px; color: #f5e6d0; padding: 10px 12px; width: 100%; font-size: 14px; outline: none; transition: border 0.2s; font-family: 'Lato', sans-serif; -webkit-appearance: none; appearance: none; }
    input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.7) sepia(1) saturate(2) hue-rotate(10deg); cursor: pointer; }
    input:focus, select:focus { border-color: #ff9a3c; }
    input::placeholder { color: rgba(245,230,208,0.4); }
    select option { background: #2a1005; color: #f5e6d0; }
    button.primary { background: linear-gradient(135deg, #e8650a, #c94b00); border: none; color: white; border-radius: 10px; padding: 13px 28px; font-size: 15px; cursor: pointer; font-family: 'Lato', sans-serif; letter-spacing: 0.5px; transition: opacity 0.2s, transform 0.1s; width: 100%; }
    button.primary:hover { opacity: 0.9; transform: translateY(-1px); }
    button.primary:active { transform: translateY(0); }
    button.ghost { background: transparent; border: 1px solid rgba(255,160,60,0.4); color: #ffb870; border-radius: 8px; padding: 6px 14px; font-size: 13px; cursor: pointer; font-family: 'Lato', sans-serif; transition: all 0.2s; white-space: nowrap; }
    button.ghost:hover { background: rgba(255,160,60,0.1); }
    .expense-row { display: flex; align-items: center; padding: 11px 0; border-bottom: 1px solid rgba(255,160,60,0.1); gap: 10px; }
    .expense-row:last-child { border-bottom: none; }
    .del-btn { background: rgba(255,60,60,0.15); border: 1px solid rgba(255,60,60,0.3); color: #ff8080; border-radius: 8px; padding: 5px 9px; cursor: pointer; font-size: 12px; flex-shrink: 0; transition: all 0.2s; }
    .del-btn:hover { background: rgba(255,60,60,0.3); }
    .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #e8650a; color: white; padding: 12px 28px; border-radius: 50px; font-family: 'Lato'; font-size: 14px; box-shadow: 0 4px 20px rgba(0,0,0,0.4); animation: fadeup 0.3s ease; z-index: 999; white-space: nowrap; }
    @keyframes fadeup { from { opacity:0; transform: translateX(-50%) translateY(10px); } to { opacity:1; transform: translateX(-50%) translateY(0); } }
    .payer-btn { flex: 1; padding: 9px 4px; border-radius: 9px; border: 1px solid rgba(255,255,255,0.15); background: rgba(0,0,0,0.25); color: rgba(245,230,208,0.5); font-family: 'Lato', sans-serif; font-size: 13px; cursor: pointer; transition: all 0.2s; text-align: center; }
    .divider-v { width: 1px; background: rgba(255,160,60,0.2); align-self: stretch; }
    .mountain { position: absolute; bottom: 0; left: 0; right: 0; opacity: 0.07; pointer-events: none; }
    .payer-bar { height: 6px; border-radius: 3px; transition: width 0.5s ease; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    const EXCHANGE_RATE_KEY = "cpt_exchange_rate";
    const EXPENSES_KEY = "cpt_expenses";
    const DEFAULT_RATE = 19.8;

    const storage = {
      get: (key) => {
        try { const v = localStorage.getItem(key); return v ? { value: v } : null; } catch { return null; }
      },
      set: (key, value) => {
        try { localStorage.setItem(key, value); } catch {}
      }
    };

    function formatDate(dateStr) {
      if (!dateStr) return "";
      const [y, m, d] = dateStr.split("-");
      return `${d}.${m}.${y}`;
    }

    const CATEGORIES = [
      { label: "ðŸ½ï¸ Essen", value: "food" },
      { label: "ðŸš— Transport", value: "transport" },
      { label: "ðŸ¨ Unterkunft", value: "accommodation" },
      { label: "ðŸŽŸï¸ AktivitÃ¤ten", value: "activities" },
      { label: "ðŸ›ï¸ Shopping", value: "shopping" },
      { label: "ðŸ’Š Sonstiges", value: "other" },
    ];

    const PAYERS = [
      { label: "Filip", value: "filip", color: "#60a5fa" },
      { label: "Julia", value: "julia", color: "#f472b6" },
      { label: "Gemeinsam", value: "gemeinsam", color: "#a78bfa" },
    ];

    const payerColor = (v) => PAYERS.find((p) => p.value === v)?.color || "#ffb870";
    const payerLabel = (v) => PAYERS.find((p) => p.value === v)?.label || v;
    const fmt = (n) => n.toLocaleString("de-DE", { minimumFractionDigits: 2, maximumFractionDigits: 2 });

    function App() {
      const today = new Date().toISOString().split("T")[0];

      const [expenses, setExpenses] = useState([]);
      const [rate, setRate] = useState(DEFAULT_RATE);
      const [form, setForm] = useState({ date: today, amount: "", description: "", category: "food", payer: "filip" });
      const [editingRate, setEditingRate] = useState(false);
      const [tempRate, setTempRate] = useState(DEFAULT_RATE);
      const [filterDate, setFilterDate] = useState("");
      const [toast, setToast] = useState(null);

      useEffect(() => {
        const r = storage.get(EXPENSES_KEY);
        if (r) { try { setExpenses(JSON.parse(r.value)); } catch {} }
        const rr = storage.get(EXCHANGE_RATE_KEY);
        if (rr) { const v = parseFloat(rr.value); if (!isNaN(v)) { setRate(v); setTempRate(v); } }
      }, []);

      const showToast = (msg) => { setToast(msg); setTimeout(() => setToast(null), 2500); };

      const saveExpenses = (updated) => {
        setExpenses(updated);
        storage.set(EXPENSES_KEY, JSON.stringify(updated));
      };

      const addExpense = () => {
        if (!form.amount || isNaN(parseFloat(form.amount)) || !form.date) return;
        const newExp = { id: Date.now(), date: form.date, amount: parseFloat(form.amount), description: form.description || "Keine Beschreibung", category: form.category, payer: form.payer };
        saveExpenses([newExp, ...expenses]);
        setForm({ date: today, amount: "", description: "", category: "food", payer: form.payer });
        showToast("Ausgabe hinzugefÃ¼gt âœ“");
      };

      const deleteExpense = (id) => { saveExpenses(expenses.filter((e) => e.id !== id)); showToast("Eintrag gelÃ¶scht"); };

      const saveRate = () => {
        const r = parseFloat(tempRate);
        if (!isNaN(r) && r > 0) { setRate(r); storage.set(EXCHANGE_RATE_KEY, String(r)); }
        setEditingRate(false);
      };

      const filtered = filterDate ? expenses.filter((e) => e.date === filterDate) : expenses;
      const groupedByDate = filtered.reduce((acc, e) => { if (!acc[e.date]) acc[e.date] = []; acc[e.date].push(e); return acc; }, {});
      const sortedDates = Object.keys(groupedByDate).sort((a, b) => b.localeCompare(a));
      const totalZAR = filtered.reduce((s, e) => s + e.amount, 0);
      const allTotal = expenses.reduce((s, e) => s + e.amount, 0);

      const getCatEmoji = (val) => CATEGORIES.find((c) => c.value === val)?.label.split(" ")[0] || "ðŸ’Š";
      const getCatName = (val) => CATEGORIES.find((c) => c.value === val)?.label.split(" ").slice(1).join(" ") || "Sonstiges";

      return (
        <div style={{ fontFamily: "'Georgia', serif", minHeight: "100vh", color: "#f5e6d0", paddingBottom: 60 }}>

          <div style={{ position: "relative", overflow: "hidden", padding: "48px 24px 34px", textAlign: "center" }}>
            <svg className="mountain" viewBox="0 0 800 200" xmlns="http://www.w3.org/2000/svg">
              <polygon points="0,200 200,60 350,130 500,20 650,100 800,50 800,200" fill="#ff9a3c"/>
            </svg>
            <p style={{ fontFamily: "'Lato', sans-serif", fontSize: 11, letterSpacing: 3, color: "#ff9a3c", textTransform: "uppercase", marginBottom: 10 }}>Reise-Budget</p>
            <h1 style={{ fontFamily: "'Playfair Display', serif", fontSize: 34, fontWeight: 700, lineHeight: 1.1, marginBottom: 6 }}>Kapstadt</h1>
            <p style={{ fontSize: 13, color: "rgba(245,230,208,0.5)", fontFamily: "'Lato', sans-serif" }}>Ausgaben-Tracker</p>
          </div>

          <div style={{ maxWidth: 540, margin: "0 auto", padding: "0 16px", display: "flex", flexDirection: "column", gap: 18 }}>

            <div className="card" style={{ display: "flex", alignItems: "center", justifyContent: "space-around", gap: 8 }}>
              <div style={{ textAlign: "center" }}>
                <div style={{ fontSize: 20, fontFamily: "'Playfair Display', serif", color: "#ffb870" }}>{fmt(totalZAR)} R</div>
                <div style={{ fontSize: 11, color: "rgba(245,230,208,0.5)", letterSpacing: 1, textTransform: "uppercase", marginTop: 4, fontFamily: "'Lato', sans-serif" }}>{filterDate ? formatDate(filterDate) : "Gesamt"} Â· ZAR</div>
              </div>
              <div className="divider-v" />
              <div style={{ textAlign: "center" }}>
                <div style={{ fontSize: 20, fontFamily: "'Playfair Display', serif", color: "#ffb870" }}>â‚¬ {fmt(totalZAR / rate)}</div>
                <div style={{ fontSize: 11, color: "rgba(245,230,208,0.5)", letterSpacing: 1, textTransform: "uppercase", marginTop: 4, fontFamily: "'Lato', sans-serif" }}>Euro</div>
              </div>
              <div className="divider-v" />
              <div style={{ textAlign: "center" }}>
                <div style={{ fontSize: 20, fontFamily: "'Playfair Display', serif", color: "#ffb870" }}>{filtered.length}</div>
                <div style={{ fontSize: 11, color: "rgba(245,230,208,0.5)", letterSpacing: 1, textTransform: "uppercase", marginTop: 4, fontFamily: "'Lato', sans-serif" }}>EintrÃ¤ge</div>
              </div>
            </div>

            {filtered.length > 0 && (
              <div className="card">
                <p className="field-label" style={{ marginBottom: 14 }}>Anteil pro Person</p>
                <div style={{ display: "flex", flexDirection: "column", gap: 12 }}>
                  {PAYERS.map((p) => {
                    const total = filtered.filter((e) => e.payer === p.value).reduce((s, e) => s + e.amount, 0);
                    const pct = totalZAR > 0 ? (total / totalZAR) * 100 : 0;
                    return (
                      <div key={p.value}>
                        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "baseline", marginBottom: 6 }}>
                          <span style={{ fontFamily: "'Lato', sans-serif", fontSize: 14, color: p.color }}>{p.label}</span>
                          <span style={{ fontFamily: "'Lato', sans-serif", fontSize: 13 }}>
                            <span style={{ color: "rgba(245,230,208,0.85)" }}>{fmt(total)} R</span>
                            <span style={{ color: "rgba(245,230,208,0.4)", margin: "0 5px" }}>Â·</span>
                            <span style={{ color: "rgba(245,230,208,0.5)" }}>â‚¬ {fmt(total / rate)}</span>
                            <span style={{ color: "rgba(245,230,208,0.3)", fontSize: 11, marginLeft: 6 }}>{pct.toFixed(0)}%</span>
                          </span>
                        </div>
                        <div style={{ background: "rgba(255,255,255,0.08)", borderRadius: 3, height: 5 }}>
                          <div className="payer-bar" style={{ width: `${pct}%`, background: p.color, minWidth: total > 0 ? 4 : 0 }} />
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}

            <div className="card" style={{ display: "flex", alignItems: "center", gap: 12, flexWrap: "wrap" }}>
              <span style={{ fontFamily: "'Lato', sans-serif", fontSize: 13, color: "rgba(245,230,208,0.6)", flex: 1 }}>
                ðŸ’± Kurs: <strong style={{ color: "#ffb870" }}>1 â‚¬ = {rate} ZAR</strong>
              </span>
              {editingRate ? (
                <div style={{ display: "flex", gap: 8, alignItems: "center" }}>
                  <input type="number" value={tempRate} onChange={(e) => setTempRate(e.target.value)} style={{ width: 90, padding: "7px 10px", fontSize: 14 }} step="0.1" />
                  <button className="ghost" onClick={saveRate}>âœ“</button>
                  <button className="ghost" onClick={() => setEditingRate(false)}>âœ•</button>
                </div>
              ) : (
                <button className="ghost" onClick={() => { setEditingRate(true); setTempRate(rate); }}>Anpassen</button>
              )}
            </div>

            <div className="card">
              <h2 style={{ fontFamily: "'Playfair Display', serif", fontSize: 19, marginBottom: 16 }}>+ Ausgabe eintragen</h2>
              <div style={{ display: "flex", flexDirection: "column", gap: 12 }}>
                <div>
                  <label className="field-label">Datum</label>
                  <input type="date" value={form.date} onChange={(e) => setForm({ ...form, date: e.target.value })} />
                </div>
                <div>
                  <label className="field-label">Betrag (ZAR)</label>
                  <input type="number" placeholder="z.B. 350" value={form.amount} onChange={(e) => setForm({ ...form, amount: e.target.value })} min="0" step="0.01" />
                </div>
                {form.amount && !isNaN(parseFloat(form.amount)) && (
                  <p style={{ fontSize: 13, color: "#ff9a3c", fontFamily: "'Lato', sans-serif", textAlign: "right", marginTop: -4 }}>
                    â‰ˆ â‚¬ {fmt(parseFloat(form.amount) / rate)}
                  </p>
                )}
                <div>
                  <label className="field-label">Kategorie</label>
                  <select value={form.category} onChange={(e) => setForm({ ...form, category: e.target.value })}>
                    {CATEGORIES.map((c) => <option key={c.value} value={c.value}>{c.label}</option>)}
                  </select>
                </div>
                <div>
                  <label className="field-label">Wer hat gezahlt?</label>
                  <div style={{ display: "flex", gap: 8 }}>
                    {PAYERS.map((p) => (
                      <button
                        key={p.value}
                        className="payer-btn"
                        style={{
                          color: form.payer === p.value ? p.color : "rgba(245,230,208,0.5)",
                          borderColor: form.payer === p.value ? p.color : "rgba(255,255,255,0.15)",
                          background: form.payer === p.value ? `${p.color}20` : "rgba(0,0,0,0.25)",
                        }}
                        onClick={() => setForm({ ...form, payer: p.value })}
                      >
                        {p.label}
                      </button>
                    ))}
                  </div>
                </div>
                <div>
                  <label className="field-label">Beschreibung</label>
                  <input type="text" placeholder="z.B. Braai am Strand" value={form.description} onChange={(e) => setForm({ ...form, description: e.target.value })} onKeyDown={(e) => e.key === "Enter" && addExpense()} />
                </div>
                <button className="primary" onClick={addExpense}>HinzufÃ¼gen</button>
              </div>
            </div>

            <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
              <div style={{ flex: 1 }}>
                <input type="date" value={filterDate} onChange={(e) => setFilterDate(e.target.value)} />
              </div>
              {filterDate && <button className="ghost" onClick={() => setFilterDate("")}>Alle anzeigen</button>}
            </div>

            {sortedDates.length === 0 ? (
              <div className="card" style={{ textAlign: "center", padding: "40px 20px", color: "rgba(245,230,208,0.4)", fontFamily: "'Lato', sans-serif" }}>
                Noch keine Ausgaben eingetragen.<br />GenieÃŸ Kapstadt! ðŸŒ…
              </div>
            ) : (
              sortedDates.map((date) => {
                const dayExpenses = groupedByDate[date];
                const dayTotal = dayExpenses.reduce((s, e) => s + e.amount, 0);
                const dayPayers = PAYERS.map((p) => ({
                  ...p,
                  total: dayExpenses.filter((e) => e.payer === p.value).reduce((s, e) => s + e.amount, 0),
                })).filter((p) => p.total > 0);
                return (
                  <div key={date} className="card">
                    <div style={{ display: "flex", justifyContent: "space-between", alignItems: "baseline", marginBottom: 10 }}>
                      <h3 style={{ fontFamily: "'Playfair Display', serif", fontSize: 18 }}>{formatDate(date)}</h3>
                      <div style={{ textAlign: "right" }}>
                        <span style={{ color: "#ffb870", fontSize: 14, fontFamily: "'Lato', sans-serif" }}>{fmt(dayTotal)} R</span>
                        <span style={{ color: "rgba(245,230,208,0.4)", fontSize: 12, marginLeft: 6, fontFamily: "'Lato', sans-serif" }}>Â· â‚¬ {fmt(dayTotal / rate)}</span>
                      </div>
                    </div>
                    {dayPayers.length > 0 && (
                      <div style={{ display: "flex", gap: 6, marginBottom: 12, flexWrap: "wrap" }}>
                        {dayPayers.map((p) => (
                          <span key={p.value} style={{ fontFamily: "'Lato', sans-serif", fontSize: 12, color: p.color, background: `${p.color}18`, border: `1px solid ${p.color}40`, borderRadius: 20, padding: "3px 10px" }}>
                            {p.label}: {fmt(p.total)} R
                          </span>
                        ))}
                      </div>
                    )}
                    <div style={{ borderTop: "1px solid rgba(255,160,60,0.1)", paddingTop: 4 }}>
                      {dayExpenses.map((exp) => (
                        <div key={exp.id} className="expense-row">
                          <span style={{ fontSize: 17, flexShrink: 0 }}>{getCatEmoji(exp.category)}</span>
                          <div style={{ flex: 1, minWidth: 0 }}>
                            <p style={{ fontFamily: "'Lato', sans-serif", fontSize: 14, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{exp.description}</p>
                            <p style={{ fontSize: 11, color: "rgba(245,230,208,0.4)", fontFamily: "'Lato', sans-serif", marginTop: 2 }}>
                              {getCatName(exp.category)}
                              {exp.payer && <span style={{ marginLeft: 5, color: payerColor(exp.payer) }}>Â· {payerLabel(exp.payer)}</span>}
                            </p>
                          </div>
                          <div style={{ textAlign: "right", flexShrink: 0 }}>
                            <p style={{ fontFamily: "'Lato', sans-serif", fontSize: 13, color: "#ffb870" }}>{fmt(exp.amount)} R</p>
                            <p style={{ fontSize: 11, color: "rgba(245,230,208,0.4)", fontFamily: "'Lato', sans-serif" }}>â‚¬ {fmt(exp.amount / rate)}</p>
                          </div>
                          <button className="del-btn" onClick={() => deleteExpense(exp.id)}>âœ•</button>
                        </div>
                      ))}
                    </div>
                  </div>
                );
              })
            )}
          </div>

          {expenses.length > 0 && (
            <div style={{ maxWidth: 540, margin: "18px auto 0", padding: "0 16px 60px" }}>
              <div className="card" style={{ borderColor: "rgba(255,160,60,0.35)" }}>
                <p className="field-label" style={{ marginBottom: 18, fontSize: 12, letterSpacing: 2 }}>ðŸ“Š Gesamtauswertung (alle Tage)</p>
                <div style={{ display: "flex", flexDirection: "column", gap: 16 }}>
                  {PAYERS.map((p) => {
                    const total = expenses.filter((e) => e.payer === p.value).reduce((s, e) => s + e.amount, 0);
                    const pct = allTotal > 0 ? (total / allTotal) * 100 : 0;
                    return (
                      <div key={p.value}>
                        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "baseline", marginBottom: 7 }}>
                          <span style={{ fontFamily: "'Playfair Display', serif", fontSize: 16, color: p.color }}>{p.label}</span>
                          <div style={{ textAlign: "right" }}>
                            <span style={{ fontFamily: "'Lato', sans-serif", fontSize: 15, color: "#ffb870" }}>{fmt(total)} R</span>
                            <span style={{ fontFamily: "'Lato', sans-serif", fontSize: 13, color: "rgba(245,230,208,0.5)", marginLeft: 8 }}>â‚¬ {fmt(total / rate)}</span>
                            <span style={{ fontFamily: "'Lato', sans-serif", fontSize: 12, color: "rgba(245,230,208,0.3)", marginLeft: 6 }}>{pct.toFixed(0)}%</span>
                          </div>
                        </div>
                        <div style={{ background: "rgba(255,255,255,0.07)", borderRadius: 4, height: 7 }}>
                          <div style={{ width: `${pct}%`, height: "100%", borderRadius: 4, background: p.color, transition: "width 0.5s ease", minWidth: total > 0 ? 4 : 0 }} />
                        </div>
                      </div>
                    );
                  })}
                  <div style={{ borderTop: "1px solid rgba(255,160,60,0.15)", paddingTop: 14, display: "flex", justifyContent: "space-between", alignItems: "baseline" }}>
                    <span style={{ fontFamily: "'Lato', sans-serif", fontSize: 12, color: "rgba(245,230,208,0.4)", letterSpacing: 1, textTransform: "uppercase" }}>Gesamt</span>
                    <div style={{ textAlign: "right" }}>
                      <span style={{ fontFamily: "'Lato', sans-serif", fontSize: 15, color: "#ffb870" }}>{fmt(allTotal)} R</span>
                      <span style={{ fontFamily: "'Lato', sans-serif", fontSize: 13, color: "rgba(245,230,208,0.5)", marginLeft: 8 }}>â‚¬ {fmt(allTotal / rate)}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}

          {toast && <div className="toast">{toast}</div>}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
